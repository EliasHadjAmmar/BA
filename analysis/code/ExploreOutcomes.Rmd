## Exploration: Outcomes

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '~/GitHub/BA')
library(tidyverse)
library(cowplot)
library(viridisLite)
```

### Data import and summary

```{r data import}
data <- read.csv("analysis/input/build.csv")
```

### Naive plot

```{r}

ListCitiesNotNA <- function(data, outcome, window=1300:1918){
  ids <- data %>% 
    filter(year %in% window) %>% 
    drop_na({{outcome}}) %>% 
    distinct(city_id) %>% 
    .$city_id
  return(ids)
}

const_cities <- ListCitiesNotNA(data, construction)
allen_cities <- ListCitiesNotNA(data, real_wage)
both <- intersect(const_cities, allen_cities)
colour_vec <- c("gold", "cornflowerblue", "coral")
names(colour_vec) <- allen_cities

PlotOutcomeLines <- function(outcome, colour_vec, dt=data, city_list=NULL, window=1300:1918){
  if (length(city_list) == 0){
    city_list <- ListCitiesNotNA(dt, {{outcome}}, window)
  }

  plot <- dt %>% 
    filter(city_id %in% city_list & year %in% window) %>% 
    mutate(city_id = factor(city_id)) %>% 
    drop_na({{outcome}}) %>% 
    ggplot(aes(x=year, y={{outcome}}))+
    geom_line(aes(colour=city_id))+
    scale_color_manual("City", values=colour_vec)+
    scale_x_continuous(limits=c(min(window), max(window)))

  return(plot)
}

wage_plot <- PlotOutcomeLines(real_wage, colour_vec)
wratio_plot <- PlotOutcomeLines(welfare_ratio, colour_vec)
const_plot <- PlotOutcomeLines(construction, colour_vec, city_list = both)

plot_grid(wage_plot, wratio_plot, const_plot, align="v", axis="b", ncols=1)
ggsave("const_wages.png", device = "png", path="analysis/output/exploration")
```

The line plots work really well for the wage data, but not so much for the 25-yearly construction data. It may look better for the yearly construction data, though.

What's striking and concerning is that they really don't match at all. Maybe I need to control for something? How would that work, though?

Now I want to see construction for some more cities, but not for multiple thousand.

```{r}

TopConstCities <- function(data, which=1:8, by="obs", window=1300:1918){
  cities_life <- data %>% 
    filter(year %in% window) %>% 
    group_by(city_id) %>% 
    summarise(
      lifetime_construction = sum(construction, na.rm=TRUE),
      observations = sum(!is.na(construction))
      )
  
  if (by == "obs"){
    top_ids <- cities_life %>% 
      arrange(desc(observations), desc(lifetime_construction))
  } else {
    top_ids <- cities_life %>% 
      arrange(desc(lifetime_construction), desc(observations))
  }
  
  return(top_ids$city_id[which])
}

Plot4 <- function(which4){
  upper <- 1 + 4*which4
  lower <- 4 + 4*which4
  city_list <- TopConstCities(data, lower:upper)
  colour_vec <- viridis(4)
  names(colour_vec) <- city_list
  PlotOutcomeLines(construction, colour_vec, city_list = city_list)
}


plot1 <- Plot4(0)
plot2 <- Plot4(1)
plot3 <- Plot4(2)
plot4 <- Plot4(3)

plot_grid(plot1, plot2, plot3, plot4)
ggsave("const_four.png", device = "png", path="analysis/output/exploration")

```

This looks messy as fuck, even for only five cities. Again, I hope that this will look better when the changes happen yearly, not simultaneously every 25 years. Actually, since most cities in most years will have only a single event recorded, I will probably plot it as a histogram and try out various bin sizes. Write a separate Plot function for that.
