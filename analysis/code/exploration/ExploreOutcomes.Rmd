## Exploration: Outcomes

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '~/GitHub/BA')
library(tidyverse)
library(cowplot)
library(viridisLite)
```

### Data import and summary

```{r data import}
data <- read.csv("analysis/input/build_full.csv")

cities_life <- data %>% 
  group_by(city_id) %>% 
  summarise(
    lifetime_construction = sum(construction, na.rm=TRUE),
    observations = sum(!is.na(construction)), # not super meaningful
    pop1875 = min(pop1875), # should be same as max(pop1875)
    datayears = max(year) - min(year)
    )

```

### List cities to plot

```{r}
ListCitiesNotNA <- function(data, outcome, window=1300:1918){
  ids <- data %>% 
    filter(year %in% window) %>% 
    drop_na({{outcome}}) %>% 
    distinct(city_id) %>% 
    .$city_id
  return(ids)
}


ListTopCities <- function(data, which=1:8, by="obs", window=1300:1918){
  cities_life <- data |> 
    filter(year %in% window) |> 
    group_by(city_id) |> 
    summarise(
      lifetime_construction = sum(construction, na.rm=TRUE),
      observations = sum(!is.na(construction)) # not super meaningful
      )
  
  if (by == "obs"){
    top_ids <- cities_life |> 
      arrange(desc(observations), desc(lifetime_construction))
  } else {
    top_ids <- cities_life |> 
      arrange(desc(lifetime_construction), desc(observations))
  }
  
  return(top_ids$city_id[which])
}
```

```{r}
# city list for comparison
const_cities <- ListCitiesNotNA(data, construction)
allen_cities <- ListCitiesNotNA(data, real_wage)
both <- intersect(const_cities, allen_cities)

# city lists for exploring construction
set.seed(151101)
top9 <- ListTopCities(data, which=1:9)
top16 <- ListTopCities(data, which=1:16)
random9 <- sample(const_cities, 9)
random16 <- sample(const_cities, 16)

```

### Plotting functions

```{r}
PlotOutcomeLines <- function(data, citylist=NULL, outcome, colour_vec, window=1300:1918){
  if (length(citylist) == 0){
    city_list <- ListCitiesNotNA(data, {{outcome}}, window)
  }
  plot <- data %>% 
    filter(city_id %in% citylist & year %in% window) %>% 
    mutate(city_id = factor(city_id)) %>% 
    drop_na({{outcome}}) %>% 
    ggplot(aes(x=year, y={{outcome}}))+
    geom_line(aes(colour=city_id))+
    scale_color_manual("City", values=colour_vec)+
    scale_x_continuous(limits=c(min(window), max(window)))

  return(plot)
}

PlotHistograms <- function(data, citylist, binw=10){
  data |>
    filter(city_id %in% citylist) |> 
    mutate(city_id = as_factor(city_id)) |> 
    filter(construction > 0) |> 
    ggplot(aes(x=year))+
    geom_histogram(aes(y=after_stat(density)), binwidth = binw)+
    geom_density(aes(y=after_stat(density), colour="red"), show.legend = FALSE)+
    facet_wrap(~city_id)
}

PlotDensity <- function(data, citylist, colour_vec, window=1300:1918){
  data |>
    filter(city_id %in% citylist & year %in% window) |> 
    mutate(city_id = as_factor(city_id)) |> 
    filter(construction > 0) |> 
    ggplot(aes(x=year))+
    geom_density(aes(y=after_stat(density), colour=city_id))+
    scale_color_manual("City", values=colour_vec)+
    scale_x_continuous(limits=c(min(window), max(window)))
}
  
```


### Comparison to real wages

```{r plots for Allen cities}
colour_vec <- c("gold", "cornflowerblue", "coral")
names(colour_vec) <- allen_cities

wage_plot <- PlotOutcomeLines(data, citylist=both, real_wage, colour_vec, window=1400:1800)
wratio_plot <- PlotOutcomeLines(data, citylist=both, welfare_ratio, colour_vec, window=1400:1800)
const_plot <- PlotDensity(data, citylist = both, colour_vec, window=1400:1800)

plot_grid(wage_plot, wratio_plot, const_plot, align="v", axis="b", ncols=1)
# ggsave("const_wages.png", device = "png", path="analysis/output/exploration")
```

What's striking and concerning is that they really don't match at all. Maybe I need to control for something? How would that work, though?

Now I want to see construction for some more cities, but not for multiple thousand.



```{r}

PlotHistograms(data, random16) +
  ggtitle("Construction activity: random cities")
PlotHistograms(data, top16) +
  ggtitle("Construction activity: cities with the most observations")

```

I want to see how the number of recorded events is related to
- a city's population in 1875
- a city's age

```{r}
cities_life |> 
  ggplot(aes(x=log(pop1875), y=lifetime_construction))+
  geom_point()+
  geom_smooth(method = "lm")
  
```

That's definitely a positive association right there. The slope is about 8, which means that all else being equal, a twice-as-large city will have eight more construction events recorded in the St√§dtebuch (if we extrapolate down from the 89 most populous cities in 1875). That sounds reasonable. Maybe the quality of the data isn't so bad after all? Maybe there just wasn't that much construction of notable public buildings in all these tiny cities?


If construction happens rarely, and possibly in bursts / waves (insert mental model of construction here), then it could well be that these bursts happen to be closer in time, on average, to territorial takeovers.

Two possible channels: takeover per se (gaining favour), or size.

Another idea: add ordinal minimum "<20000" for pop1875 so it's never missing