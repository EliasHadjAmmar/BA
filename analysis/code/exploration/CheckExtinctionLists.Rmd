## Sanity check extinctions

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '~/GitHub/BA')
library(tidyverse)
library(cowplot)
```

What I know so far:

- I record 382 extinctions in the ruler dataset.
- I can tell from the summary statistics of the build that the ruler dataset is not complete (i.e. the extinction dataset contains too many extinctions) because the min of final_year is 1101 while the min of year is 1300. Lack of a recorded ruler doesn't necessarily mean that the lineage is extinct. I should definitely cross-check my extinction list with the territories extinction list before picking out sub-experiments.
- There is another source for extinctions: `territories.csv`, which is published in Princes and Townspeople. It's not yearly, but I can still use it as a comparison.

```{r data import}
territories <- read_csv("build/input/territories.csv") %>% 
  select(city_id, time_point, terr_id, observation, type_reign, 
         type_change, commentary_primary, commentary_secondary)
```
### Understanding where the variation in this dataset comes from
```{r}
# Hunch: type_change varies at the observation level
mins <- territories %>% 
  group_by(observation) %>% 
  summarise(type_change = min(type_change))

maxs <- territories %>% 
  group_by(observation) %>% 
  summarise(type_change = max(type_change))

colSums(mins != maxs) # yes they're the same

```

The `observation` column has the actual observations, which are then expanded across the time_points. So what I actually want is, for each observation with type_change==3, the row with the earliest year. That yields a data set of extinction takeover observations.

### Getting type 3 takeovers
```{r get extinction takeover observations}
takeovers <- territories %>% 
  group_by(observation) %>% 
  mutate(
    min_year = min(time_point),
    type_change = min(type_change)
  ) %>% 
  filter(type_change == 3) %>% 
  ungroup() %>% 
  filter(time_point == min_year)

takeovers
```

That's 2,028 extinction observations! I feel like that's too many? That's an order of magnitude more than I have in the rulers data. Ah, but this is cities. There are 2,028 city-time-points with extinctions. So it makes more sense.

Note that `terr_id` is the lineage that takes over. I would like to know the lineage that went extinct. I need, for each observation, the terr_id of the previous time point.

### Getting the lineages that go extinct
```{r get extinct lineage}
takeover_dummies <- takeovers %>% 
  mutate(takeover = 1) %>% 
  select(observation, time_point, takeover)

terrs_with_takeovers <- left_join(territories, takeover_dummies, by=c("observation", "time_point"))

extinctions <- terrs_with_takeovers %>% 
  group_by(city_id) %>% 
  mutate(prev_terr_id = lag(terr_id, order_by = time_point)) %>% 
  ungroup() %>% 
  filter(takeover == 1) %>% 
  distinct(prev_terr_id, .keep_all=TRUE) # try including time_point here

extinctions
```

I have 392 distinct `prev_terr_id`-`time_point observations` (of which 6 previous terrs are NA), but only 306 distinct `prev_terr_id` observations. Does this mean that some lineages go extinct multiple times? Essentially yes. It means there are cities owned by Habsburg that change hands due to extinction in 1650, and there are also cities owned by Habsburg that change hands due to extinction in 1700. That doesn't make sense, does it?

But no matter - these are the extinctions that are in the territories data. How many of these are in *my* extinctions list?

### Comparing the two lists
```{r import my extinction list}
ext_rulers <- read_csv("build/temp/last_rulers.csv") %>% 
  select(terr_id, death_year, end_reign, family, name)

# Make datasets compatible
ext_rulers <- ext_rulers %>% 
  rename(prev_terr_id = terr_id)
```
```{r join and compare}
innerjoined <- inner_join(ext_rulers, extinctions, by="prev_terr_id") %>% 
  select(prev_terr_id, death_year, end_reign, time_point,
         commentary_primary, commentary_secondary)

leftjoined <- left_join(ext_rulers, extinctions, by="prev_terr_id") %>%
  select(prev_terr_id, death_year, end_reign, time_point,
         commentary_primary, commentary_secondary)

innerjoined
```

What I take away from this:
- of 382 extinctions in the ruler list, only 125 show up in the territories data.
- among those 125 extinctions there are many cases where the territories data directly confirms my data because the exact `death_year` is mentioned in a `commentary`.
- there are some cases (e.g. "0W0070") where the data sets contradict each other: there are rulers recorded until the 20th century, but there exists a city which was ruled by that lineage until it went extinct in 1639 (according to the comment)

Consider limiting the set of potential treatments to those extinctions from the ruler data which have a `commentary` from the terr data that contains the `death_year` from the ruler data.