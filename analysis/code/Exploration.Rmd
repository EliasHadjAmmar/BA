## Exploration

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '~/GitHub/BA')
library(tidyverse)
library(cowplot)
```

### Data import and summary

```{r data import}
data <- read.csv("analysis/input/build.csv")

summary(data)
```

Some initial takeaways:

- there are almost 1,100,000 observations in my dataset.
- the min of final_year is 1101 while the min of year is 1300. This means that the ruler dataset is not complete, i.e. lack of a recorded ruler doesn't necessarily mean that the lineage is extinct. I should definitely cross-check my extinction list with the territories extinction list before picking out sub-experiments.
- the median final ruler dies in 1920.
- the share of city-year observations in which the ruling lineage goes extinct is 0.374%.

### Observations

#### Number of observations per year

```{r observations across time}
ggplot(data) + 
  geom_bar(aes(x=year))
```

Looks fairly smooth except for the big jump around 1800, and the drop around 1350.

It's promising that there's a large number of observations (which should correspond to cities 1:1) for every single year.

#### Is each observation a unique city-year?

```{r duplicate keys}
obs_vs_distinct <- data %>% count() - data %>% distinct() %>% count()
obs_vs_city_year <- data %>% count() - data %>% distinct(city_id, year) %>% count()
share_dupes <- obs_vs_city_year/(data %>% count())

sprintf("Duplicate rows: %s", obs_vs_distinct)
sprintf("Rows wih duplicate keys: %s", obs_vs_city_year)
sprintf("Share of rows with duplicate keys: %s", share_dupes)

```

Yes. each observation has a unique city-year key.

### Lineages

#### Getting lineage-year observations

```{r lineage level data}
terrs <- data %>% 
  distinct(terr_id, year, .keep_all=TRUE) %>% 
  select(terr_id, year, territory, count_cities, final_full_year, extinction)

# terrs <- read_csv("build/output/lineages.csv") # comment out for sanity check
```

Note: this only keeps the first city-year observation for each lineage-year.
However, we only use this data set to look at variables that are identical for 
all city-years in a lineage-year, so `count_cities` and `extinction`. I did a sanity check: the following plots look exactly the same for the lineages.csv data.

#### Number of distinct lineages across time

```{r number of lineages across time}
yearly_plot <- terrs %>% 
  ggplot(aes(x=year))+
  geom_bar()

# count distinct terr_ids that show up in a century
centuries_plot <- terrs %>% 
  mutate(century = year - year %% 100) %>% # round year down to century
  distinct(century, terr_id) %>% # else counts territory-year observations
  ggplot(aes(x=century))+
  geom_bar()

plot_grid(yearly_plot, centuries_plot, labels = c("Yearly", "Centuries"))
```

That is pretty cool. The most striking thing is Napoleon, of course.
But it's also important to note that the number of territories continues to
steeply decline throughout the entire 19th century. Keep that in mind when you
summarise by century later.

This is the Number of Nations. I also want the Size of Nations.

#### Territory size across time

```{r territory size across time}
terrs_centuries <- terrs %>% 
  mutate(century = year - year %% 100) %>% 
  mutate(century = factor(century)) %>% # necessary for boxplots or else year = width
  group_by(century, terr_id) %>% # group and average because the total no. of cities per year
  summarise(count_cities = mean(count_cities)) # jumps in 1800; I ASSUME this is an artifact
  # comment out the last two lines to see the effect of that!
  
# create plot with outliers
size_time <- terrs_centuries %>% 
  ggplot() + 
  geom_boxplot(aes(x = century, y = count_cities))

# create plot with no outliers
size_time_no_outliers <- terrs_centuries %>% 
  ggplot() + 
  geom_boxplot(aes(x = century, y = count_cities), outlier.shape = NA) +
  coord_cartesian(ylim = quantile(terrs_centuries$count_cities, c(0, 0.93)))

# plot side by side
plot_grid(size_time, size_time_no_outliers, labels = c("Full plot", "Zoom"))
```

It would be good to zoom into the 17th to 20th century and use half-centuries, because this hides the considerable within-century variation in the 1800s. 

### Extinctions

#### Cities affected by lineage extinction across time
```{r extinction treatments across time}

CityExtPlot <- function(full_data, bins){
  plt <- full_data %>% 
    filter(extinction == 1) %>% 
    ggplot(aes(x=year))+
    geom_histogram(binwidth = bins)
  return(plt)
}

plot_grid(CityExtPlot(data, 1), CityExtPlot(data, 10),
          CityExtPlot(data, 30), CityExtPlot(data, 50))

```

#### Lineages that go extinct across time
```{r lineage extinctions across time}

TerrExtPlot <- function(terrs, bins){
  plt <- terrs %>% 
    filter(extinction == 1) %>% 
    ggplot(aes(x=year))+
    geom_histogram(binwidth = bins)
  return(plt)
}

plot_grid(TerrExtPlot(terrs, 1), TerrExtPlot(terrs, 10),
          TerrExtPlot(terrs, 30), TerrExtPlot(terrs, 50))

```

#### Are larger lineages more or less likely to have a recorded extinction?
```{r extinct vs non-extinct}
terrs_life <- terrs %>% 
  group_by(terr_id) %>% 
  summarise(
    extinction_ever = max(extinction), 
    max_size = max(count_cities), # compare maximum size across lifespan
    lifespan = max(year) - min(year)
    ) %>% 
  mutate(extinction_ever = factor(extinction_ever)) # necessary or else year = width

size_ext <- terrs_life %>% 
  ggplot() + 
  geom_boxplot(aes(x = extinction_ever, y=max_size))

size_ext_no_outliers <- terrs_life %>% 
  ggplot() + 
  geom_boxplot(aes(x = extinction_ever, y=max_size), outlier.shape = NA) +
  coord_cartesian(ylim = quantile(terrs_life$max_size, c(0, 0.93)))

plot_grid(size_ext, size_ext_no_outliers, labels = c("Full plot", "Zoom"))
```

#### Distribution of lineage lifespan

```{r lifespan of lineages}
terrs_life %>% 
  ggplot()+
  geom_histogram(aes(x=lifespan))
```

#### Correlation between size and survival

```{r}
#mod_lifespan_size <- lm(lifespan ~ log(max_size), data=terrs_life)
#summary(mod_lifespan_size)

lifespan_on_max_size <- terrs_life %>% 
  ggplot(aes(x=log(max_size), y=lifespan))+
  geom_point()+
  geom_smooth(method="lm", se=FALSE)

ext_on_cities <- terrs %>% 
  ggplot(aes(x=count_cities, y=extinction))+
  geom_point()
  
plot_grid(lifespan_on_max_size, ext_on_cities)

```

Left: The lifespan of a lineage is weakly correlated to its maximum lifetime size.
Right: This honestly doesn't say much. What it tries to say is that lineages may be less likely to go extinct when they are larger.

### Cities

#### Lifetime summary statistics for cities

```{r}
cities_life <- data %>% 
  group_by(city_id) %>% 
  summarise(
    years_exists = max(year) - min(year),
    rulers_count = n_distinct(terr_id),
    extinctions_count = sum(extinction),
    diffs_count = sum(count_diff != 0, na.rm=TRUE),
    mean_integ = mean(count_cities),
    lifetime_integ_diff = sum(count_diff, na.rm=TRUE),
    mean_yearly_diff = mean(count_diff, na.rm=TRUE),
    sd_yearly_diff = sd(count_diff, na.rm=TRUE)
    )

# check whether diffs_count works:
# only1001 <- data[data$city_id == 1001,]
# sum(only1001$count_diff != 0, na.rm = TRUE) # there are 57 nonzero countdiffs
# cities_life %>% filter(city_id == 1001) %>% select(diffs_count) # yes it works

summary(cities_life)
```

This is very insightful. Some takeaways:

- I have almost 500 observations on average for each city.
- **A normal city changes hands 3-4 times throughout its history.**
- **Of these territory changes, 1-2 are due to extinction.**
- **A normal city undergoes around 60 changes in integration.**
- Less than a quarter of cities is integrated with less than 100 other cities on average throughout its history.
- Most cities become drastically more integrated over time.
- Yearly differences in integration are positive on average but vary a lot.



