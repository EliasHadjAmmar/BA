---
title: "Triangulating extinctions"
output: html_document
date: "2023-01-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '~/GitHub/BA')
library(tidyverse)
library(haven)
```

I have two separate sources for extinction events:
- the territories data (`observation` with `type_change`=3)
- the rulers data (final observation of a `terr_id`)
How much do they align?

```{r look at territories data}
territories <- read.csv("build/input/territories.csv")
takeovers <- territories %>% 
  select(city_id, terr_id, sovereign_number, time_point, observation, point_id, 
         type_reign, type_change, city_status, foreign_rule) %>% 
  filter(type_change==3) %>% 
  group_by(observation) %>% 
  summarise(first_year = min(time_point))
```

And with that, I might already have a list of all ruler extinctions in the territory data - the events are there, I just need to extract the previous territory (which will probably be a pain). Unless an observation can refer to multiple terr_ids. Then nevermind.

```{r check about observations and terrs}
territories <- read.csv("build/input/territories.csv")
takeovers <- territories %>% 
  select(city_id, terr_id, sovereign_number, time_point, observation, point_id, 
         type_reign, type_change, city_status, foreign_rule) %>% 
  filter(type_change==3) %>% 
  group_by(observation, time_point) %>% 
  summarise(count = n()) %>% summary()
print(takeovers)

```
Okay no, perfect. An observation only ever corresponds to one territory. Unless I did something wrong, which I definitely won't rule out. But if I did, I'm guessing / hoping that bugs will bring it to my attention.
This means I can use the observations as a key to first get the rest of the information back (year, dynasty usurping the city) and then the original dynasty as well.

I love that we get the exact cities from the territories data and the exact timing from the rulers data and the exact outcomes from the cities data.

```{r attempt at extracting previous territory}
territories %>% 
  select(city_id, terr_id, sovereign_number, time_point, observation, point_id, 
         type_reign, type_change, city_status, foreign_rule) %>% 
  
  
  
```

