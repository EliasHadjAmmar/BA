## Exploration

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '~/GitHub/BA')
library(tidyverse)
library(cowplot)
```

### Data import and summary

```{r data import}
data <- read.csv("analysis/input/build_full.csv")

summary(data)
```

Some initial takeaways:

- there are almost 1,100,000 observations in my dataset.
- the min of final_year is 1101 while the min of year is 1300. This means that the ruler dataset is not complete, i.e. lack of a recorded ruler doesn't necessarily mean that the lineage is extinct. I should definitely cross-check my extinction list with the territories extinction list before picking out sub-experiments.
- the median final ruler dies in 1920.
- the share of city-year observations in which the ruling lineage goes extinct is 0.374%.

### Observations

#### Number of observations per year

```{r observations across time}
ggplot(data) + 
  geom_bar(aes(x=year)) +
  labs(
    title="Number of observations across time"
  )

#ggsave("obs_yearly.png", device="png", path="analysis/output/exploration")
```

Looks fairly smooth except for the big jump around 1800, and the drop around 1350.

It's promising that there's a large number of observations (which should correspond to cities 1:1) for every single year.

#### Is each observation a unique city-year?

```{r duplicate keys}
obs_vs_distinct <- data %>% count() - data %>% distinct() %>% count()
obs_vs_city_year <- data %>% count() - data %>% distinct(city_id, year) %>% count()
share_dupes <- obs_vs_city_year/(data %>% count())

sprintf("Duplicate rows: %s", obs_vs_distinct)
sprintf("Rows wih duplicate keys: %s", obs_vs_city_year)
sprintf("Share of rows with duplicate keys: %s", share_dupes)

```

Yes. each observation has a unique city-year key.

### Lineages

#### Getting lineage-year observations

```{r lineage level data}
terrs <- data %>% 
  distinct(terr_id, year, .keep_all=TRUE) %>% 
  select(terr_id, year, territory, count_cities, final_full_year, extinction)

# terrs <- read_csv("build/output/lineages.csv") # comment out for sanity check
```

Note: this only keeps the first city-year observation for each lineage-year.
However, we only use this data set to look at variables that are identical for 
all city-years in a lineage-year, so `count_cities` and `extinction`. I did a sanity check: the following plots look exactly the same for the lineages.csv data.

#### Number of distinct lineages across time

```{r number of lineages across time}
yearly_plot <- terrs %>% 
  ggplot(aes(x=year))+
  geom_bar()+
  labs(
    title="Distinct lineages across time"
  )

# count distinct terr_ids that show up in a century
centuries_plot <- terrs %>% 
  mutate(century = year - year %% 100) %>% # round year down to century
  distinct(century, terr_id) %>% # else counts territory-year observations
  ggplot(aes(x=century))+
  geom_bar()+
  labs(
    title="Distinct lineages in each century"
  )

plot_grid(yearly_plot, centuries_plot)
#ggsave("terrs_yearly_cents.png", device="png", path="analysis/output/exploration")
```

That is pretty cool. The most striking thing is Napoleon, of course.
But it's also important to note that the number of territories continues to
steeply decline throughout the entire 19th century. Keep that in mind when you
summarise by century later.

This is the Number of Nations. I also want the Size of Nations.

#### Territory size across time

```{r territory size across time}
terrs_centuries <- terrs %>% 
  mutate(century = year - year %% 100) %>% 
  mutate(century = factor(century)) %>% # necessary for boxplots or else year = width
  group_by(century, terr_id) %>% # group and average because the total no. of cities per year
  summarise(count_cities = mean(count_cities)) # jumps in 1800; I ASSUME this is an artifact
  # comment out the last two lines to see the effect of that!
  
# create plot with outliers
size_time <- terrs_centuries %>% 
  ggplot() + 
  geom_boxplot(aes(x = century, y = count_cities))+
  labs(
    title="Territory size across time",
    y = "Mean city count"
  )

# create plot with no outliers
size_time_no_outliers <- terrs_centuries %>% 
  ggplot() + 
  geom_boxplot(aes(x = century, y = count_cities), outlier.shape = NA) +
  coord_cartesian(ylim = quantile(terrs_centuries$count_cities, c(0, 0.93)))+
    labs(
    title="Zoom",
    y = "Mean city count"
  )

# plot side by side
plot_grid(size_time, size_time_no_outliers)
#ggsave("terrsize_cents_boxplot.png", device="png", path="analysis/output/exploration")

```

It would be good to zoom into the 17th to 20th century and use half-centuries, because this hides the considerable within-century variation in the 1800s. 

### Extinctions

#### Cities affected by lineage extinction across time
```{r extinction treatments across time}

CityExtPlot <- function(full_data, bins, title){
  plt <- full_data %>% 
    filter(extinction == 1) %>% 
    ggplot(aes(x=year))+
    geom_histogram(binwidth = bins)+
    labs(
      title=title
    )
  return(plt)
}

plot_grid(CityExtPlot(data, 1, "Cities affected by extinction, yearly"), CityExtPlot(data, 10, "10-year bins"),
          CityExtPlot(data, 30, "30-year bins"), CityExtPlot(data, 50, "50-year bins"))

#ggsave("cities_ext.png", device="png", path="analysis/output/exploration")
```

#### Lineages that go extinct across time
```{r lineage extinctions across time}

TerrExtPlot <- function(terrs, bins, title){
  plt <- terrs %>% 
    filter(extinction == 1) %>% 
    ggplot(aes(x=year))+
    geom_histogram(binwidth = bins)+
    labs(
      title=title
    )
  return(plt)
}

plot_grid(TerrExtPlot(terrs, 1, "Lineage extinctions, yearly"), TerrExtPlot(terrs, 10, "10-year bins"),
          TerrExtPlot(terrs, 30, "30-year bins"), TerrExtPlot(terrs, 50, "50-year bins"))
#ggsave("terrs_ext.png", device="png", path="analysis/output/exploration")

```

#### Are larger lineages more or less likely to have a recorded extinction?
```{r extinct vs non-extinct}
terrs_life <- terrs %>% 
  group_by(terr_id) %>% 
  summarise(
    extinction_ever = max(extinction), 
    max_size = max(count_cities), # compare maximum size across lifespan
    lifespan = max(year) - min(year)
    ) %>% 
  mutate(extinction_ever = factor(extinction_ever)) # necessary or else year = width

size_ext <- terrs_life %>% 
  ggplot() + 
  geom_boxplot(aes(x = extinction_ever, y=max_size))+
  coord_flip()+
  labs(
    title="Maximum size of lineages with recorded extinction"
  )

size_ext_no_outliers <- terrs_life %>% 
  ggplot() + 
  geom_boxplot(aes(x = extinction_ever, y=max_size), outlier.shape = NA) +
  coord_flip(ylim = quantile(terrs_life$max_size, c(0, 0.915)))+
  labs(
    title="Zoom"
  )


plot_grid(size_ext, size_ext_no_outliers, ncol = 1)
#ggsave("ext_max_size.png", device="png", path="analysis/output/exploration")

```

#### Distribution of lineage lifespan

```{r lifespan of lineages}
terrs_life %>% 
  ggplot()+
  geom_histogram(aes(x=lifespan))+
  labs(
    title="Distribution of lineage lifespan",
    subtitle="(Last year minus first year that lineage shows up in the city data)"
  )

#ggsave("lifespan_histo.png", device="png", path="analysis/output/exploration")
```

#### Correlation between size and survival

```{r eval=FALSE, include=FALSE}
#mod_lifespan_size <- lm(lifespan ~ log(max_size), data=terrs_life)
#summary(mod_lifespan_size)

lifespan_on_max_size <- terrs_life %>% 
  ggplot(aes(x=log(max_size), y=lifespan))+
  geom_point()+
  geom_smooth(method="lm", se=FALSE)

ext_on_cities <- terrs %>% 
  ggplot(aes(x=count_cities, y=extinction))+
  geom_point()
  
plot_grid(lifespan_on_max_size, ext_on_cities)

```

(The below refers to the output of a deactivated cell.)
Left: The lifespan of a lineage is weakly correlated to its maximum lifetime size.
Right: This honestly doesn't say much. What it tries to say is that lineages may be less likely to go extinct when they are larger.

### Cities

#### Lifetime summary statistics for cities

```{r}

cities_life <- data %>% 
  group_by(city_id) %>% 
  summarise(
    years_exists = max(year) - min(year),
    rulers_count = n_distinct(terr_id),
    extinctions_count = sum(extinction),
    diffs_count = sum(count_diff != 0, na.rm=TRUE),
    mean_integ = mean(count_cities),
    lifetime_integ_diff = sum(count_diff, na.rm=TRUE),
    mean_yearly_diff = mean(count_diff, na.rm=TRUE),
    sd_yearly_diff = sd(count_diff, na.rm=TRUE),
    lifetime_construction = sum(construction, na.rm=TRUE),
    across( # count non-missing observations of each outcome
      c(real_wage, welfare_ratio, construction), 
      ~ sum(!is.na(.x)),
      .names = "years_{.col}"
      )
    ) %>% 
  mutate(years_construction = years_construction * 25)

# check whether diffs_count works:
# only1001 <- data[data$city_id == 1001,]
# sum(only1001$count_diff != 0, na.rm = TRUE) # there are 57 nonzero countdiffs
# cities_life %>% filter(city_id == 1001) %>% select(diffs_count) # yes it works

summary(cities_life)
```

This is very insightful. Some takeaways:

- I have almost 500 observations on average for each city.
- **A normal city changes hands 3-4 times throughout its history.**
- **Of these territory changes, 1-2 are due to extinction.**
- **A normal city undergoes around 60 changes in integration.**
- Less than a quarter of cities is integrated with less than 100 other cities on average throughout its history.
- Most cities become drastically more integrated over time.
- Yearly differences in integration are positive on average but vary a lot.


#### City size across time

```{r}

plot_integ <- function(data, width, startyear=1300, endyear=1918){
  cities <- data %>% 
    filter(year >= startyear & year <= endyear) %>% 
    mutate(period = year - year %% width) %>% 
    mutate(period = factor(period)) %>%
    group_by(period, city_id) %>% 
    summarise(mean_integ = mean(count_cities))
  
  plot <- cities %>% 
    ggplot() +
    geom_boxplot(aes(x = period, y = mean_integ))+
    labs(
      title=sprintf("Integration of cities (period mean), %i-%i", startyear, endyear)
    )
  
  return(plot)
}

#plot_integ(data, 10, startyear=1800)

integ_50y <- plot_integ(data, 50)
integ_1600_25y <- plot_integ(data, 25, startyear=1600)
integ_1800_10y <- plot_integ(data, 10, startyear=1750)

plot_grid(integ_50y, integ_1600_25y, integ_1800_10y,
          align="v", ncol=1)
#ggsave("city_integ_boxplots.png", device="png", path="analysis/output/exploration")
```

The political integration of cities stagnates until 1750, starts to quickly and steadily increase from the late 18th to mid-19th century, and then jumps abruptly with Prussia getting the Norddeutscher Bund in 1866. 

Because we average within decades, this is kind of misleading. It appears like the jump happens in two stages: one in the 1860s and one in the 1870s. As we see below, that's not what's really in the data: there is only one jump for Prussia, in 1866. Because it's in the middle of the 1860s, the 1860 boxplot is halfway between 1850 and 1870, making it seem like there's another jump in the 1870s. This isn't actually the case, though (at least not for Prussia).

#### Dynamics of the largest territories
```{r}
plot_top_terrs <- function(data, how_many, window=0:2000){
  threshold = 2
  
  top_terrs <- data %>% 
    group_by(terr_id) %>% 
    summarise(
      max_size = max(count_cities),
      years_in_window = sum(year %in% window)) %>% 
    filter(years_in_window > threshold) %>% 
    arrange(desc(max_size)) %>% 
    slice(1:how_many)
  
  top_data <- data %>% 
    filter(year %in% window) %>% 
    filter(terr_id %in% top_terrs$terr_id) %>% 
    distinct(year, terr_id, .keep_all = TRUE)
  
  plot <- top_data %>% 
    ggplot(aes(x=year, y=count_cities))+
    geom_line(aes(colour=terr_id))
  
  return(plot)
}

full_plot <- plot_top_terrs(data, 9)
zoom_plot <- plot_top_terrs(data, 6, window = 1800:1900)

plot_grid(full_plot, zoom_plot, align="v", ncol=1, labels=c("Full", "1800s"))

# figure out how to unify the colour legends before saving this!

```

The top panel shows that there's a problem with H010. Apparently there are some missing values, i.e. the territory disappears from the dataset for around 300 years and then reappears. Before I output any exploration graphs that will go in the paper, I should take care of this in Cleaning.R.

Also, this is very messy. If I put something like this in the paper, I should probably use facets of a single ggplot, so the colour-territory-correspondence is the same and there is only one legend.